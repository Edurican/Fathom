# =============================================================================
# AI Question Generator
# =============================================================================
# PR이 생성되면 발표 내용을 기반으로 AI가 질문을 자동 생성합니다.
#
# 지원 AI Provider:
#   - openai     : OpenAI (GPT-4, GPT-4o, GPT-3.5-turbo 등)
#   - anthropic  : Anthropic (Claude 3.5, Claude 3 등)
#   - google     : Google (Gemini Pro, Gemini Flash 등)
#   - openai-compatible : OpenAI 호환 API (Groq, Together AI, Ollama 등)
#
# 필수 Secrets 설정:
#   - AI_API_KEY  : API 키
#
# 선택 Secrets 설정:
#   - AI_PROVIDER : AI 제공자 (기본값: openai)
#   - AI_MODEL    : 모델명 (기본값: provider별 기본 모델)
#   - AI_BASE_URL : 커스텀 API URL (openai-compatible 사용 시 필수)
# =============================================================================

name: AI Question Generator

on:
  pull_request:
    types: [opened]
    paths:
      - '**/README.md'
      - '!.github/**'
      - '!templates/**'
      - '!members/**'

env:
  # 기본값 설정 (Secrets에서 오버라이드 가능)
  DEFAULT_PROVIDER: 'openai'
  DEFAULT_OPENAI_MODEL: 'gpt-4o'
  DEFAULT_ANTHROPIC_MODEL: 'claude-sonnet-4-20250514'
  DEFAULT_GOOGLE_MODEL: 'gemini-1.5-flash'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get presentation content
        id: content
        run: |
          # 변경된 README.md 중 발표자료 찾기
          FILE=$(git diff --name-only origin/main HEAD | grep -E '^\d{4}/week.*/README.md$' | head -1)
          
          if [ -z "$FILE" ]; then
            echo "발표자료 README 없음"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT
          
          # 내용 추출 (4000자 제한)
          CONTENT=$(head -c 4000 "$FILE")
          
          # multiline output 처리
          echo "content<<CONTENT_EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "CONTENT_EOF" >> $GITHUB_OUTPUT

      - name: Generate AI Questions
        if: steps.content.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          CONTENT: ${{ steps.content.outputs.content }}
        with:
          script: |
            const content = process.env.CONTENT;
            const apiKey = process.env.AI_API_KEY;
            
            if (!apiKey) {
              console.log('AI_API_KEY not configured, skipping...');
              return;
            }
            
            // Provider 및 모델 설정
            const provider = (process.env.AI_PROVIDER || 'openai').toLowerCase();
            let model = process.env.AI_MODEL;
            let baseUrl = process.env.AI_BASE_URL;
            
            // 기본 모델 설정
            if (!model) {
              switch (provider) {
                case 'anthropic':
                  model = 'claude-sonnet-4-20250514';
                  break;
                case 'google':
                  model = 'gemini-1.5-flash';
                  break;
                case 'openai':
                case 'openai-compatible':
                default:
                  model = 'gpt-4o';
                  break;
              }
            }
            
            const prompt = `다음은 개발자 스터디 발표 자료입니다. 이 내용을 바탕으로:

            1. 면접에서 나올 수 있는 심화 질문 3개
            2. 실무 적용 관점의 질문 2개

            총 5개의 질문을 만들어주세요. 질문만 간결하게 번호와 함께 작성해주세요.

            ---
            ${content}
            ---`;
            
            let questions = '';
            
            try {
              // ========== OpenAI / OpenAI Compatible ==========
              if (provider === 'openai' || provider === 'openai-compatible') {
                const url = baseUrl || 'https://api.openai.com/v1/chat/completions';
                
                const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1000
                  })
                });
                
                const data = await response.json();
                
                if (data.error) {
                  throw new Error(data.error.message);
                }
                
                questions = data.choices[0].message.content;
              }
              
              // ========== Anthropic (Claude) ==========
              else if (provider === 'anthropic') {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                  },
                  body: JSON.stringify({
                    model: model,
                    max_tokens: 1000,
                    messages: [{ role: 'user', content: prompt }]
                  })
                });
                
                const data = await response.json();
                
                if (data.error) {
                  throw new Error(data.error.message);
                }
                
                questions = data.content[0].text;
              }
              
              // ========== Google (Gemini) ==========
              else if (provider === 'google') {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                  })
                });
                
                const data = await response.json();
                
                if (data.error) {
                  throw new Error(data.error.message);
                }
                
                questions = data.candidates[0].content.parts[0].text;
              }
              
              else {
                throw new Error(`Unknown provider: ${provider}`);
              }
              
              // PR에 코멘트 작성
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## 🤖 AI가 생성한 질문

            발표 때 아래 질문들도 함께 다뤄보세요!

            ${questions}

            ---
            > 💡 이 질문들은 AI(${provider}/${model})가 자동 생성했습니다.
            > QnA.md에 답변을 정리해주세요!`
              });
              
              console.log(`Successfully generated questions using ${provider}/${model}`);
              
            } catch (error) {
              console.error('AI API Error:', error.message);
              
              // 에러 발생 시에도 코멘트 남기기
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ⚠️ AI 질문 생성 실패

            AI 질문 생성 중 오류가 발생했습니다.

            \`\`\`
            Provider: ${provider}
            Model: ${model}
            Error: ${error.message}
            \`\`\`

            > 수동으로 질문을 작성하거나, Repository Secrets 설정을 확인해주세요.`
              });
            }
