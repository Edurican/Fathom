name: Update README

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update presentation table
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            
            // PR ì œëª© íŒŒì‹±: [week01] í™ê¸¸ë™ - Spring Batch
            const match = pr.title.match(/\[week(\d+)\]\s*(\S+)\s*-\s*(.+)/i);
            if (!match) {
              console.log('PR ì œëª©ì´ ì»¨ë²¤ì…˜ê³¼ ë§ì§€ ì•ŠìŒ, ìŠ¤í‚µ');
              return;
            }
            
            const [, week, author, topic] = match;
            const date = new Date().toLocaleDateString('ko-KR', {
              month: '2-digit',
              day: '2-digit'
            }).replace('. ', '-').replace('.', '');
            
            console.log(`Week: ${week}, Author: ${author}, Topic: ${topic}`);
            
            // README ì½ê¸°
            let readme = fs.readFileSync('README.md', 'utf8');
            
            // ìƒˆ í–‰ ìƒì„± (ë§í¬ëŠ” PR ë§í¬ë¡œ)
            const newRow = `| ${week} | ${date} | ${author} | [${topic.trim()}](${pr.html_url}) | ğŸŒŠğŸŒŠ |`;
            
            // í…Œì´ë¸”ì— ì¶”ê°€ (Dive Log ì„¹ì…˜ ì°¾ì•„ì„œ)
            const tablePattern = /(## ğŸ“š Dive Log[\s\S]*?\|[\s\S]*?\|[\s\S]*?\|[\s\S]*?\|[\s\S]*?\|[\s\S]*?\|)\n(\n|##)/;
            
            if (tablePattern.test(readme)) {
              readme = readme.replace(tablePattern, `$1\n${newRow}\n$2`);
              fs.writeFileSync('README.md', readme);
              console.log('README ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } else {
              console.log('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "ğŸ“Š ë°œí‘œ ê¸°ë¡ ìë™ ì—…ë°ì´íŠ¸"
          git push